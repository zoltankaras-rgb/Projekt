<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modul Expedícia</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root {
            --primary-color: #f59e0b; --primary-hover: #d97706; --secondary-color: #6b7280; 
            --secondary-hover: #4b5563; --success-color: #16a34a; --warning-color: #f59e0b; 
            --danger-color: #ef4444; --danger-hover: #dc2626; --light-gray: #f3f4f6; 
            --medium-gray: #e5e7eb; --dark-gray: #374151; --font-family: 'Inter', sans-serif;
            --border-radius: 0.5rem; --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        body { font-family: var(--font-family); background-color: var(--light-gray); color: var(--dark-gray); margin: 0; padding: 2rem; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        .app-container, .login-container { width: 100%; max-width: 900px; background-color: white; border-radius: var(--border-radius); box-shadow: var(--shadow); overflow: hidden; }
        .app-header { background-color: var(--primary-color); color: white; padding: 1.5rem; }
        .app-header h1 { margin: 0; font-size: 1.75rem; font-weight: 700; }
        .app-header p { margin: 0.25rem 0 0; opacity: 0.8; }
        .app-content { padding: 1.5rem; }
        .login-container { max-width: 400px; padding: 2.5rem; margin-top: 5rem;}
        .login-container h2 { text-align: center; margin-top: 0; }
        .hidden { display: none !important; }
        .view { display: none; }
        .section { background-color: white; padding: 1.5rem; border: 1px solid var(--medium-gray); border-radius: var(--border-radius); margin-bottom: 1.5rem; }
        h3 { text-align: center; font-size: 1.25rem; margin-top: 0; margin-bottom: 1.5rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--medium-gray); }
        h4 { margin-top: 1.5rem; margin-bottom: 1rem; }
        label { display: block; margin-top: 1rem; font-weight: 500; font-size: 0.875rem; margin-bottom: 0.25rem; }
        input, select, textarea { width: 100%; padding: 0.75rem; margin-top: 0.25rem; border-radius: 0.375rem; border: 1px solid var(--medium-gray); box-sizing: border-box; font-family: inherit; }
        button { width: 100%; padding: 0.75rem 1rem; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.9rem; margin-top: 1.25rem; font-weight: 600; transition: background-color 0.2s; }
        .btn-primary { background-color: var(--primary-color); } .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-success { background-color: var(--success-color); }
        .btn-info { background-color: #0ea5e9; }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-warning { background-color: var(--warning-color); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; }
        #status { padding: 12px; border-radius: 5px; text-align: center; display: none; margin-top: 1rem; }
        .success { background-color: #d1fae5; color: #065f46; } .error { background-color: #fee2e2; color: #991b1b; }
        .table-container { max-height: 400px; overflow-y: auto; border: 1px solid var(--medium-gray); border-radius: var(--border-radius); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--medium-gray); }
        th { background-color: var(--light-gray); font-weight: 600; position: sticky; top: 0; }
        .batch-row-ok { background-color: #f0fdf4; }
        #scanner-container { width: 100%; max-width: 500px; margin: auto; border: 2px solid var(--medium-gray); border-radius: var(--border-radius);}
    </style>
</head>
<body>

    <div id="login-wrapper" class="login-container">
        <h2><i class="fas fa-boxes-stacked"></i> Modul Expedícia</h2>
        <form id="login-form"><div class="form-group"><label for="username">Používateľské meno:</label><input type="text" id="username" required autocomplete="username"></div><div class="form-group"><label for="password">Heslo:</label><input type="password" id="password" required autocomplete="current-password"></div><button type="submit" class="btn-primary">Prihlásiť sa</button></form>
        <div id="status"></div>
    </div>

    <div id="app-container" class="app-container hidden">
        <header class="app-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div><h1>Modul Expedícia</h1><p id="user-info">Vitajte, ...</p></div>
                <button id="logout-button" class="btn-danger" style="width: auto; margin: 0;"><i class="fas fa-sign-out-alt"></i> Odhlásiť sa</button>
            </div>
        </header>
        <main id="expedition-module-container" class="app-content">
            
            <div id="view-expedition-menu" class="view">
                <div class="section">
                    <h3>Hlavné Menu</h3>
                    <!-- ZAČIATOK KĽÚČOVEJ ÚPRAVY -->
                    <button class="btn-primary" style="margin-bottom: 1rem;" onclick="loadProductionDates()"><i class="fas fa-dolly"></i> Prevziať Tovar z Výroby</button>
                    <!-- KONIEC KĽÚČOVEJ ÚPRAVY -->
                    <div class="btn-grid">
                        <button class="btn-primary" onclick="startBarcodeScanner()"><i class="fas fa-barcode"></i> Skenovať Šaržu</button>
                        <button class="btn-warning" onclick="loadAndShowProductInventory()"><i class="fas fa-clipboard-check"></i> Inventúra</button>
                        <button class="btn-success" onclick="loadAndShowManualReceive()"><i class="fas fa-plus-square"></i> Manuálny Príjem</button>
                        <button class="btn-info" onclick="loadAndShowSlicingRequest()"><i class="fas fa-cut"></i> Požiadavka Krájanie</button>
                        <button class="btn-danger" onclick="loadAndShowManualDamage()"><i class="fas fa-exclamation-triangle"></i> Odpis Škody</button>
                    </div>
                </div>

                <div class="section" id="slicing-section-container">
                    <h4>Prebiehajúce Krájanie</h4>
                    <div id="pending-slicing-container" class="table-container">Načítavam...</div>
                </div>
            </div>
            
            <!-- ZAČIATOK KĽÚČOVEJ ÚPRAVY: Nové pohľady pre preberanie tovaru -->
            <div id="view-expedition-date-selection" class="view">
                <div class="section">
                    <h3>Krok 1: Zvoľte deň výroby</h3>
                    <div id="expedition-date-container" class="btn-grid"></div>
                </div>
                <button onclick="showExpeditionView('view-expedition-menu')" class="btn-secondary"><i class="fas fa-arrow-left"></i> Späť na Menu</button>
            </div>

            <div id="view-expedition-batch-list" class="view">
                <div class="section">
                    <h3 id="expedition-batch-list-title">Krok 2: Prevzatie výrobkov</h3>
                    <div class="form-group" style="max-width: 300px;">
                         <label for="expedition-worker-name">Meno preberajúceho:</label>
                         <input type="text" id="expedition-worker-name" style="margin-top:0;">
                    </div>
                    <div id="expedition-batch-table" class="table-container"></div>
                    <div id="expedition-action-buttons" style="margin-top: 1rem;"></div>
                </div>
                <button onclick="showExpeditionView('view-expedition-date-selection')" class="btn-secondary"><i class="fas fa-arrow-left"></i> Späť na výber dátumu</button>
            </div>
            <!-- KONIEC KĽÚČOVEJ ÚPRAVY -->

            <div id="view-expedition-inventory" class="view">
                <div class="section">
                    <h3>Inventúra Finálnych Produktov</h3><p>Zadajte reálny stav len pre položky, ktoré chcete upraviť.</p>
                    <label for="inventory-worker-name">Meno pracovníka:</label><input type="text" id="inventory-worker-name">
                    <div id="product-inventory-tables-container"></div>
                    <button class="btn-warning" onclick="submitProductInventory()"><i class="fas fa-save"></i> Potvrdiť a Zapísať Inventúru</button>
                </div>
                <button onclick="showExpeditionView('view-expedition-menu')" class="btn-secondary"><i class="fas fa-arrow-left"></i> Späť na Menu</button>
            </div>
            
            <div id="view-expedition-manual-receive" class="view">
                <div class="section"><h3>Manuálny Príjem Výrobkov</h3><label for="manual-receive-worker-name">Vaše Meno:</label><input type="text" id="manual-receive-worker-name"><label for="manual-receive-date">Dátum:</label><input type="date" id="manual-receive-date"><label for="manual-receive-product-select">Produkt:</label><select id="manual-receive-product-select"></select><label for="manual-receive-quantity">Množstvo (ks/kg):</label><input type="number" id="manual-receive-quantity" min="1"><button class="btn-success" onclick="submitManualReceive()">Potvrdiť Príjem</button></div>
                <button onclick="showExpeditionView('view-expedition-menu')" class="btn-secondary"><i class="fas fa-arrow-left"></i> Späť na Menu</button>
            </div>
            
            <div id="view-expedition-slicing-request" class="view">
                <div class="section"><h3>Požiadavka na krájanie</h3><label for="slicing-product-select">Zvoľte finálny balíček (produkt):</label><select id="slicing-product-select"></select><label for="slicing-planned-pieces">Plánovaný počet kusov:</label><input type="number" id="slicing-planned-pieces" min="1"><button class="btn-info" onclick="submitSlicingRequest()">Vytvoriť Požiadavku</button></div>
                <button onclick="showExpeditionView('view-expedition-menu')" class="btn-secondary"><i class="fas fa-arrow-left"></i> Späť na Menu</button>
            </div>
            
            <div id="view-expedition-manual-damage" class="view">
                <div class="section">
                    <h3>Manuálny Odpis Škody</h3><label for="damage-worker-name">Vaše Meno:</label><input type="text" id="damage-worker-name"><label for="damage-product-select">Produkt:</label><select id="damage-product-select"></select><label id="damage-quantity-label" for="damage-quantity">Množstvo (ks/kg):</label><input type="number" id="damage-quantity" min="1"><label for="damage-note">Dôvod odpisu:</label><textarea id="damage-note" rows="3"></textarea><button class="btn-danger" onclick="submitManualDamage()">Potvrdiť Odpis</button>
                </div>
                <button onclick="showExpeditionView('view-expedition-menu')" class="btn-secondary"><i class="fas fa-arrow-left"></i> Späť na Menu</button>
            </div>
            
            <div id="view-expedition-scanner" class="view">
                <div class="section">
                    <h3>Skenovanie Šarže</h3>
                    <p>Namierte kameru na čiarový kód na produkte.</p>
                    <div id="scanner-container"></div>
                    <div id="scan-result" style="text-align: center; margin-top: 1rem; font-weight: bold;"></div>
                </div>
                <button onclick="stopBarcodeScanner()" class="btn-secondary"><i class="fas fa-arrow-left"></i> Späť na Menu</button>
            </div>
        </main>
    </div>
    <script src="/static/js/common.js"></script>
    <script src="/static/js/expedicia.js"></script>
</body>
</html>
